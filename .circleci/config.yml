version: 2
jobs:
  build:
    docker:
      # CircleCI Go images available at: https://hub.docker.com/r/circleci/golang/
      - image: docker:17.10.0-ce-git
      - image: circleci/golang:1.8

    environment:
      VERSION: "1.28.1515.73"
      SOURCE_URL: "https://github.com/pritunl/pritunl/archive/1.28.1515.73.tar.gz"

    steps:
      - checkout
      - setup_remote_docker
      - run: docker build --tag build-wheels -f Dockerfile.build ./

      - run:
          name: Fetch pritunl source
          command: |
            apk --no-cache add ca-certificates
            wget $SOURCE_URL
            tar xzf ${VERSION}.tar.gz && mv pritunl-${VERSION} pritunl

      - run:
          name: Build pritunl wheels and copy back to the primary machine
          command: |
            docker create --name data -v /wheels -v pritunl alpine:3.6 /bin/true
            docker cp pritunl data:/
            docker run -t --volumes-from data -w pritunl build-wheels
            docker cp data:/wheels ./

      # - run:
      #     name: Build resulting container
      #     command: |
      #       docker run -t
      # - run: docker build -t build-container -f Dockerfile.build ./

      # - run: |
      #     docker run -it -v $(pwd)/pritunl:/pritunl \
      #                    -v $(pwd)/wheels:/wheels \
      #                    -w /pritunl build-container

      # - run: go get github.com/pritunl/pritunl-dns
      # - run: go get github.com/pritunl/pritunl-web
      # - run: pwd
      # - run: find /home
